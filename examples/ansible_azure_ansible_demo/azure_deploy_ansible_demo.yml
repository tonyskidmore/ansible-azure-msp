---
- name: Deploy azure resource manager group
  hosts: localhost
  connection: local
  tags:
    - azure

  roles:

  - name: azure VM provisioning
    role: azure_rm_group
    tags:
      - azure
      - deploy

  post_tasks:

  - name: deployment variable
    debug:
      var: azure_deployment
      verbosity: "{{ verbosity_level }}"

  - name: refresh the inventory
    meta: refresh_inventory
    tags:
      - azure
      - inventory

  - name: display groups
    debug:
      var: groups
      verbosity: "{{ verbosity_level }}"

- name:  Deploy server roles
  hosts: role_ansible:role_jumphost:role_docker
  strategy: free
  tags:
    - azure
    - awx
    - docker

  pre_tasks:

  - name: wait for VMs
    wait_for_connection:
      timeout: 300

  tasks:

  - import_tasks: ansible-awx.yml
    when: "'role_ansible' in group_names"
    tags:
      - awx-config

  - import_tasks: docker.yml
    when: "'role_docker' in group_names"
    tags:
      - docker-config

  - import_tasks: jumphost.yml
    when: "'role_jumphost' in group_names"
    tags:
      - jumphost-config
